@model Cms.Models.MultipleIndexModel
@{
    Layout = "~/Views/Shared/_LayoutCms.cshtml";
    ViewBag.Title = "Produkty";
    var modelItems = Model.ProductModel;
    var variantsAttributes = Model.VariantAttributesModel;
    //var attributes = Model.AttributesModel;
    var sizes = "";
    var onstockrange = "";
    var counter = 0;
}
<script>
    /*GET HOW MANY ON STOCK from database*/
    function Onstock(size, counter, onstockrange) {

        var mycounter = counter;
        var prod_row = document.getElementById("product_row-" + mycounter);
        var infoicon = document.getElementById("info-" + mycounter);

        if (size != "" && isNaN(size)) {
            var j = size;
            var json = $.parseJSON(j);
            var countofsize = json.length;
            var inputs = "";
            $(json).each(function (i, val) {
                if (val.stock <= onstockrange) {
                    prod_row.style.background = "#ffe2e2";
                    infoicon.style.display = "inline-block";
                }
            });
        } else if (size != "" && !isNaN(size)) {
            if (size <= onstockrange) {
                prod_row.style.background = "#ffe2e2";
                infoicon.style.display = "inline-block";
            }
        }
    }
</script>

<style>
    .sidenav > a:nth-child(3) {
        border-left: 5px solid #00abe8;
        color: #f1f1f1;
        background-color: #464646;
    }

    .dropdown-container2 {
        display: block;
    }

    .noBT {
        border-top: 0px solid white !important;
    }

    .hide {
        display: none;
    }
</style>

<h2>Produkty v eshope</h2>
<hr />
<button class="btn btn-success" type="button" value="Create" style="margin: 5px 0 10px;padding: 7px 22px;" onclick="location.href='@Url.Action("AddProduct", "Products")'">+ Pridať produkt</button>
<hr />
<button class="btn btn-warning" type="button" value="MultiPriceEdit" style="margin: 5px 0 10px;padding: 7px 22px;">Hromadne zmeniť cenu</button>
<hr />

<div class="row">
    <div class="col-4">
        <div class="mt-1" style="width: 180px;">
            <strong>Filtrovať podľa kategórie</strong>
        </div>
        <div class="form-group">
            <div class="col-md-12" style="padding-left:0px;">
                @Html.DropDownList("filterByCategory", (IEnumerable<SelectListItem>)ViewData["kategoria"], new { @class = "form-control" })
            </div>
        </div>
    </div>


    <div class="col-4" style="padding-left:0px;">
        <div class="mt-1" style="width: 180px;">
            <strong>Filtrovať podľa značky</strong>
        </div>
        <div class="form-group">
            <div class="col-md-12" style="padding-left:0px;">
                @Html.DropDownList("filterByBrand", (IEnumerable<SelectListItem>)ViewData["znacka"], new { @class = "form-control" })
            </div>
        </div>
    </div>
</div>

<hr />
<table id="productsTable" class="table">
    <thead>
        <tr>
            <th class="hide">ID</th>
            <th>Kód produktu</th>
            <th>Náhľad</th>
            <th>Názov</th>
            <th>Cena</th>
            <th>Cena po zľave</th>
            <th>Kategória</th>
            <th>Varianty</th>
            <th>Dátum</th>
            <th>Odporúčané</th>
            <th style="text-align: center">Akcie</th>
        </tr>
    </thead>
    <tbody>
        @if (ViewBag.Details == null)
        {
            foreach (var item in modelItems)
            {
                sizes = item.custom4;
                if (sizes == "" || sizes == null)
                {
                    sizes = item.stock;
                }

                onstockrange = item.custom1;
                <tr id="product_row-@counter" class="productRow">

                    <td class="hide">@item.id</td>
                    <td>@Html.DisplayFor(modelItem => item.number)</td>
                    <td><img src="~/Uploads/@Html.DisplayFor(modelItem => item.image)" style="width: 50px;" /></td>
                    <td><strong>@Html.DisplayFor(modelItem => item.title)</strong></td>
                    <td style="background-color: lightyellow; text-align: center;"><strong>@Html.DisplayFor(modelItem => item.price)&nbsp;€</strong></td>
                    <td style="background-color: lightcyan; text-align: center;">
                        <strong>
                            @{
                                //Html.DisplayFor(modelItem => item.discountprice)
                                var discountText = "";
                                if (item.discountprice != null)
                                {
                                    discountText = item.discountprice + " €";
                                }
                            }
                            @discountText
                        </strong>
                    </td>
                    <td>
                        @{
                            if (item.category != null)
                            {
                                foreach (var cat in Model.CategoriesModel.Where(o => o.id == Int32.Parse(item.category)))
                                {
                                    @Html.Raw(cat.name)
                                }
                            }
                        }
                    </td>
                    <td>

                        @{
                            //variant.number obsahuje nazov vlastnosti
                            string variantsStr = "";
                            if (variantsAttributes.Where(o => o.ProdId == item.id).ToList().Count > 0)
                            {
                                string varType = "";
                                foreach (var variant in variantsAttributes.Where(o => o.ProdId == item.id))
                                {
                                    if (varType != variant.AttrName)
                                    {
                                        variantsStr += variant.AttrName + ": ";
                                    }

                                    variantsStr += variant.AttrValue + ", ";
                                    varType = variant.AttrName;
                                }
                                variantsStr = variantsStr.Remove(variantsStr.Length - 2);
                            }
                        }
                        @variantsStr

                    </td>
                    <td>@Html.DisplayFor(modelItem => item.date)</td>
                    <td style="text-align:center;">@Html.DisplayFor(modelItem => item.recommended)</td>
                    <td align="center">
                        @Html.ActionLink("Editovať", "EditProduct", "Products", new { id = item.id }, new { @class = "btn btn-warning", style = "color: #ffffff !important; font-size:13px;margin-right: 2px;" }) <a href="@Url.Action("DuplicateProduct", "Products", new { id = item.id })" class="btn btn-success" style="padding: 5px 10px;margin-right: 2px;" title="Duplikovať produkt"><img src="~/Content/images/duplicate.png" width="15" style="margin-top: -3px;"></a> @Html.ActionLink(HttpUtility.HtmlDecode("&#215;"), "DeleteProduct", "Products", new { id = item.id, confirm = true }, new { onclick = "return confirm('Naozaj chcete vymazať tento produkt?')", @class = "btn btn-danger", style = "padding: 5px 10px;", data_toggle = "tooltip", data_placement = "top", title = "Kliknutím nenávratne vymažete produkt." })
                        <div class="popover__wrapper" id="info-@counter" style="display:none;">
                            <a href="#">
                                <strong class="popover__title"><img src="/Content/images/infobox_info_icon.svg" style="width: 18px;" /></strong>
                            </a>
                            <div class="push popover__content">
                                <p class="popover__message">Skladové zásoby pod hraničnou hodnotou!</p>
                            </div>
                        </div>
                    </td>

                </tr>



                <script>
                Onstock('@Html.Raw(sizes)', @(counter), @(onstockrange));
                </script>
                counter++;
            }


        }
    </tbody>
</table>

<script>


    $(document).ready(function () {

        $(document).ready(function () {
            $('#productsTable').DataTable({
                "order": [0, 'desc'],
                "language": {
                    "url": "https://cdn.datatables.net/plug-ins/1.10.19/i18n/Slovak.json"
                },
                "initComplete": function (settings, json) {
                    //upravime css
                    $('#productsTable tbody tr').each(function () {
                        if ($(this).hasClass("variantRow")) {
                            $(this).find("td").addClass("noBT");
                        }
                    });
                }
            });
        });

        //init
        $("#filterByCategory").val("");
        $("#filterByBrand").val("");

        $("#filterByCategory").change(function () {
            filterAjaxCatBrand();
        });

        $("#filterByBrand").change(function () {
            filterAjaxCatBrand();
        });

        function filterAjaxCatBrand() {
            let APIurl = "/Api/FetchProductsByCategoryBrand";

            $catId = $("#filterByCategory").val() == "" ? null : $("#filterByCategory").val();
            $brandId = $("#filterByBrand").val() == "" ? null : $("#filterByBrand").val();

            $.ajax({
                url: APIurl,
                type: 'GET',
                async: false,
                data: { catId: $catId, brandId: $brandId },
                dataType: 'json',
                success: function (data) {
                    //add rows to dataTable

                    $variants = data.variants;
                    $categories = data.categories;
                    data = data.data;

                    $dataSet = [];

                    for ($i = 0; $i < data.length; $i++) {

                        $variantsStr = "";
                        $varType = "";
                        $lastUsedProdId = 0;
                        $category = "";

                        //kategorie
                        if ($categories != undefined) {
                            $.each($categories, function (i, v) {
                                if (v.id == data[$i].category) {
                                    $category = v.name;

                                    return false;
                                }
                            });
                        } else {
                            $category = data[$i].category;
                        }


                        //varianty
                        $.each($variants, function (i, v) {
                            if (v.ProdId == data[$i].id) {
                                if ($varType != v.AttrName) {
                                    $variantsStr += v.AttrName + ": ";
                                }

                                $variantsStr += v.AttrValue + ", ";
                                $varType = v.AttrName;
                                $lastUsedProdId = data[$i].id;
                            }

                            //aby sa nemuseli prehladavat vsetky varianty
                            if ($lastUsedProdId != 0 && v.ProdId != $lastUsedProdId) {
                                $variantsStr = $variantsStr.slice(0, -2);
                                return false;
                            }
                        });

                        $thisSet = [];
                        $thisSet.push(data[$i].id);
                        $thisSet.push(data[$i].number);
                        $thisSet.push('<img src="/Uploads/' + data[$i].image + ' style="width: 50px; " />');
                        $thisSet.push('<strong>' + data[$i].title + '</strong>');
                        $thisSet.push('<strong>' + data[$i].price + ' €</strong>');
                        $thisSet.push('<strong>' + (data[$i].discountprice ? (data[$i].discountprice + " €") : "") + '</strong>');
                        $thisSet.push($category);
                        $thisSet.push($variantsStr);
                        $thisSet.push(data[$i].date);
                        $thisSet.push('<input class="check-box" disabled="disabled" ' + (data[$i].recommended == true ? 'checked="checked"' : '') + ' type="checkbox">');
                        $thisSet.push('<a class="btn btn-warning" href="/produkty/editovat-produkt/' + data[$i].id + '" style = "color:#ffffff !important; font-size:13px;margin-right: 2px;" >Editovať</a><a href="/Products/DuplicateProduct/' + data[$i].id + '" class="btn btn-success" style="padding: 5px 10px;margin-right: 2px;" title="Duplikovať produkt"><img src="/Content/images/duplicate.png" width="15" style="margin-top: -3px;"></a><a class="btn btn-danger" style="padding: 5px 10px;" data-placement="top" data-toggle="tooltip" href="/Products/DeleteProduct/' + data[$i].id + '?confirm=True" onclick=\'return confirm("Naozaj chcete vymazať tento produkt?")\' title="Kliknutím nenávratne vymažete produkt.">×</a>' +
                            '<div class="popover__wrapper" id="info-0" style="display:none;">' +
                            '<a href="#">' +
                            '<strong class="popover__title"><img src="/Content/images/infobox_info_icon.svg" style="width: 18px;"></strong>' +
                            '</a>' +
                            '<div class="push popover__content">' +
                            '<p class="popover__message">Skladové zásoby pod hraničnou hodnotou!</p>' +
                            '</div>' +
                            '</div>' +
                            '</td>'
                        );

                        $dataSet.push($thisSet);
                    }

                    $('#productsTable').DataTable().destroy();
                    $('#productsTable').empty();

                    $('#productsTable').DataTable({
                        "order": [0, 'desc'],
                        data: $dataSet,
                        columns: [
                            { title: "Id" },
                            { title: "Kód produktu" },
                            { title: "Náhľad" },
                            { title: "Názov" },
                            { title: "Cena" },
                            { title: "Cena po zľave" },
                            { title: "Kategória" },
                            { title: "Varianty" },
                            { title: "Dátum" },
                            { title: "Odporúčané" },
                            { title: "Akcie" }

                        ],
                        language: {
                            "url": "https://cdn.datatables.net/plug-ins/1.10.19/i18n/Slovak.json"
                        },
                        "initComplete": function (settings, json) {
                            //upravime css
                            $('#productsTable thead th').eq(0).attr("style", "display:none;");
                            //$('#productsTable thead th').eq(3).attr("style", "width: 350px;");
                            $('#productsTable thead th').eq(10).attr("style", "text-align: center;");

                            $('#productsTable tbody tr').each(function () {

                                $tds = $(this).find("td");
                                $tds.eq(0).attr("style", "display:none;");
                                $tds.eq(4).attr("style", "background-color: lightyellow; text-align: center;");
                                $tds.eq(5).attr("style", "background-color: lightcyan; text-align: center;");
                                $tds.eq(9).attr("style", "text-align: center;");
                                $tds.eq(10).attr("align", "center");
                            });
                        }
                    });
                },
                error: function () {
                    alert('Error! Please try again.');
                }
            }).done(function () {
                //$loading.remove();
            });

        }
    });
</script>

