@using System.Text.RegularExpressions
@using Cms.Controllers
@model Cms.Models.MultipleIndexModel
@{
    var search = ViewData["Search"].ToString();
    var pageSize = ViewData["PageSize"].ToString();
    var pageNumber = ViewData["PageNumber"].ToString();
    var totalPages = ViewData["TotalPages"].ToString();
    ViewBag.Title = "Výsledky vyhľadávania: " + search + " - ";

    HelperController helper = new HelperController();
}
<style>
    #front-picture, #services {
        display: none !important;
    }
</style>
<div class="container-fluid w-75">

    @if (!Model.ProductsPaged.Any())
    {
        <div class="row py-0 py-sm-4">
            <div class="col-md-8">
                <h2>Výsledky vyhľadávania: <i>@search</i></h2>
                <p>Požadovaný produkt sa nenašiel.</p>
            </div>
        </div>
    }
    else
    {
        <div class="row py-0 py-sm-4">
            <div class="col-md-8">
                <h2>Výsledky vyhľadávania: <i>@search</i></h2>
            </div>
        </div>
        <div class="row products search-products">
            <div class="col-md-12 no-gutters">
                <div class="row products-row">
                    @{
                        var prods = Model.ProductsPaged;
                        foreach (var prod in prods)
                        {
                            bool isDiscounted = false;
                            var variants = Model.VariantModel.Where(o => o.prod_id == prod.id).OrderBy(o => o.num).ToList();

                            if (variants.Count() > 0)
                            {
                                foreach (var variant in variants)
                                {
                                    if (variant.discountprice != null)
                                    {
                                        isDiscounted = true;

                                        break;
                                    }
                                }
                            }
                            else
                            {
                                if (prod.discountprice != null)
                                {
                                    isDiscounted = true;
                                }
                            }

                            var slug = helper.ToUrlSlug(prod.title);
                            <div class="col-md-5ths product mb-2 mx-1" style="margin-right: 0px;">
                                <a href="/detail-produktu/@prod.id/@slug">
                                    <div class="thumb" style="background-image: url('/Uploads/@prod.image'); height: 11vw; background-size: contain;"></div>
                                    <div class="prod-labels">
                                        @{
                                            if (isDiscounted == true)
                                            {
                                                <span class="prod-discount">akcia</span>
                                            }
                                        }

                                        @{
                                            if (DateTime.Compare(DateTime.Parse(prod.date), DateTime.Now.AddDays(-15)) >= 0)
                                            {
                                                <span class="prod-new">novinka</span>
                                            }
                                        }
                                    </div>
                                    <div class="prod-header">@Html.Raw(prod.title)</div>
                                    @{
                                        var shortdescription = "";
                                        if (prod.description != null && prod.description != "")
                                        {
                                            shortdescription = Regex.Replace(prod.description, "<.*?>", String.Empty);
                                            if (shortdescription.Length > 60)
                                            {
                                                shortdescription = shortdescription.Substring(0, 60) + "...";
                                            }
                                        }
                                    }
                                    <div class="prod-text">@Html.Raw(shortdescription)</div>
                                    <div class="prod-prices">
                                        @{
                                            decimal variantPriceFrom = 99999;
                                            string isVariant = "false";
                                            int firstAttrId = 0;
                                            foreach (var variant in variants)
                                            {

                                                if (firstAttrId == 0)
                                                {
                                                    firstAttrId = variant.attribute_id;
                                                }

                                                if (firstAttrId == variant.attribute_id)
                                                {
                                                    if (variant.discountprice != null)
                                                    {
                                                        if (variant.discountprice < variantPriceFrom)
                                                        {
                                                            variantPriceFrom = (decimal)variant.discountprice;
                                                        }
                                                    }
                                                    else
                                                    {

                                                        decimal thisPrice = 0;
                                                        //rating
                                                        if (Request.Cookies["username"] != null)
                                                        {
                                                            var usermeta = Model.AllUsersMetaModel.FirstOrDefault();
                                                            var rating = 1;
                                                            decimal defaultPrice = (decimal)variant.price;
                                                            decimal ratingPrice = 0;

                                                            if (usermeta != null)
                                                            {
                                                                rating = usermeta.rating;
                                                            }
                                                            switch (rating)
                                                            {
                                                                case 1:
                                                                    ratingPrice = (decimal)0.95 * defaultPrice;
                                                                    break;
                                                                case 2:
                                                                    ratingPrice = (decimal)0.9 * defaultPrice;
                                                                    break;
                                                                case 3:
                                                                    ratingPrice = (decimal)0.85 * defaultPrice;
                                                                    break;
                                                            }

                                                            thisPrice = ratingPrice;
                                                        }
                                                        else
                                                        {
                                                            thisPrice = (decimal)variant.price;
                                                        }

                                                        if (thisPrice < variantPriceFrom)
                                                        {
                                                            variantPriceFrom = thisPrice;
                                                        }

                                                    }
                                                }

                                                isVariant = "true";
                                            }

                                            decimal actualPrice = (decimal)0.0;
                                            if (variantPriceFrom != 99999)
                                            {
                                                <span class="prod-price-from">od @variantPriceFrom.ToString("N2") €</span>
                                            }
                                            else
                                            {

                                                if (prod.discountprice != null)
                                                {
                                                    <span class="prod-discount">@prod.price.ToString("N2") €</span>
                                                    <span class="prod-base">@(((decimal) prod.discountprice).ToString("N2")) €</span>
                                                    actualPrice = (decimal)prod.discountprice;
                                                }
                                                else
                                                {
                                                    //rating
                                                    if (Request.Cookies["username"] != null)
                                                    {
                                                        var usermeta = Model.AllUsersMetaModel.FirstOrDefault();
                                                        var rating = 1;
                                                        decimal defaultPrice = prod.price;
                                                        decimal ratingPrice = 0;

                                                        if (usermeta != null)
                                                        {
                                                            rating = usermeta.rating;
                                                        }

                                                        switch (rating)
                                                        {
                                                            case 1:
                                                                ratingPrice = (decimal)0.95 * defaultPrice;
                                                                break;
                                                            case 2:
                                                                ratingPrice = (decimal)0.9 * defaultPrice;
                                                                break;
                                                            case 3:
                                                                ratingPrice = (decimal)0.85 * defaultPrice;
                                                                break;
                                                        }

                                                        <span class="prod-discount">@defaultPrice.ToString("N2") €</span>
                                                        <span class="prod-base">@ratingPrice.ToString("N2") €</span>
                                                        actualPrice = ratingPrice;
                                                    }
                                                    else
                                                    {
                                                        <span class="prod-base">@prod.price.ToString("N2") €</span>
                                                        actualPrice = prod.price;
                                                    }
                                                }

                                            }
                                        }
                                    </div>
                                </a>

                                @{
                                    var actualPriceStr = actualPrice.ToString("N2").Replace(",", ".");
                                }

                                <span onclick='addToCart(@prod.id, @isVariant, @actualPriceStr)' class="prod-add-to-cart">
                                    <img class="prod-icon" src="~/Content/images/cart.svg">
                                    <span>Pridať do košíka</span>
                                </span>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <nav class="pagination-container pb-sm-4" aria-label="Page navigation example">
            <ul class="pagination" id="pagination">
            </ul>
        </nav>
    }
</div>

<script>
    renderPagination(@totalPages, @pageNumber);
    function renderPagination(totalPages, page) {
        var $pages = '';
        totalPages = Math.floor(totalPages);


        if (totalPages > 1 && page > 1) {
            $pages += '<li class="page-item"><a class="page-link" href="/vyhladavanie?term=' + "@search" + '&page=' + (page - 1) +'" aria-label="Previous"><span aria-hidden="true">&laquo;</span><span class="sr-only">Previous</span></a></li>';
        }


        for (i = 1; i <= totalPages; i++) {
            let active = "";
            if (i == page) { active = "active"; }
            $pages += '<li class="page-item ' + active + '"><a class="page-link" href="/vyhladavanie?term=' + "@search" + '&page=' + i +'">' + i + '</a></li>';
        }


        if (totalPages > 1 && totalPages > page) {
            $pages += '<li class="page-item"><a class="page-link" href="/vyhladavanie?term=' + "@search" + '&page=' + (page + 1) +'" aria-label="Next"><span aria-hidden="true">&raquo;</span><span class="sr-only">Next</span></a></li>';
        }


        $pages = $($pages);

        console.log($pages);

        $('#pagination').html($pages);
    }

</script>
<script src="~/Scripts/add_to_session.js"></script>